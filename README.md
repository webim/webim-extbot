# Extbot

Extbot — пример чат-бота для [Webim](https://webim.ru/). Extbot не подойдёт для общения с реальными посетителями, но сможет продемонстрировать возможности платформы. Бот представляет из себя программу, которая запускается на отдельном компьютере и подключается к Webim через [External Bot API 2.0](https://webim.ru/kb/bots/external-bot/v-2-0.html) или [External Bot API 1.0](https://webim.ru/kb/bots/external-bot/v-1-0.html).

При работе с API 2.0 Extbot умеет:

* Отправлять текст
* Отправлять файлы
* Отправлять кнопки
* Переводить диалог на оператора
* Переводить диалог на отдел
* Закрывать диалог

При работе с API 1.0 Extbot умеет:

* Отправлять текст
* Отправлять кнопки
* Переводить диалог в очередь

## Установка бота

Понадобится [Python](https://www.python.org/downloads/) 3.8+ и [pip](https://pip.pypa.io/en/stable/installation/).

Установить бота можно командой:

```shell
pip install "<ссылка-на-пакет>"
```

Где `<ссылка-на-пакет>` — путь до этого репозитория или ссылка на его скачивание в формате ZIP.

Чтобы проверить, что бот установлен, можно посмотреть его справку:

```shell
extbot --help
```

Или, если команда `extbot` не определяется:

```shell
python -m extbot --help
```

Периодически стоит повторять команду установки, чтобы установить последние обновления бота.

## Запуск бота

Когда бот успешно установлен, его можно запустить. Например:

```shell
extbot --domain demo.webim.ru --token my-secret-token
```

Команда запускает бота и выводит ссылку на его API. Для работы API 2.0 в команду необходимо передать параметр `--domain` с доменным именем, на котором доступен Webim, а также параметр `--token` с токеном бота из настроек Webim, см. "Подключение бота к Webim" ниже. Больше настроек запуска в справке `extbot --help`.

Для подключения к Webim бот должен быть доступен через публичный IP адрес. Если при запуске локально такой возможности нет, то можно воспользоваться такими сервисами, как [ngrok](https://ngrok.com/download) или [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/trycloudflare).

К примеру, по-умолчанию бот запускается на `localhost:8000`. Тогда можно запустить ngrok:

```shell
ngrok http 8000
```

И бот будет доступен по ссылке "Forwarding" из экрана ngrok до тех пор, пока ngrok запущен.

## Подключение бота к Webim

* [Инструкции для API 2.0](https://webim.ru/kb/bots/external-api/15043-robot-external-api-2-0/#setup)
* [Инструкции для API 1.0](https://webim.ru/kb/bots/external-api/12394-robot-external-api/#setup)

В поле "Ссылка на внешний API" указывается полученная при запуске бота ссылка.

## Дополнительные возможности

### Раздельные URL для API 2.0 и 1.0

Когда Extbot получает HTTP-запрос со стороны Webim, он определяет используемую версию API по заголовку X-Bot-API-Version. Заголовок появился только в Webim 10.3, поэтому для более старых или нестандартных релизов у бота есть дополнительные URL-пути `/v2` и `/v1` для API 2.0 и 1.0 соответственно.

Предположим, после запуска бота он выводит API URL: `http://localhost:8000/`. Далее запускается `ngrok http 8000`, который выводит Forwarding: `https://extbot.example.com/`. Тогда в настройках бота в Webim можно указать одну из ссылок:

* `https://extbot.example.com/` — бот определит версию API автоматически, но только для Webim 10.3+
* `https://extbot.example.com/v2` — бот будет использовать только API 2.0
* `https://extbot.example.com/v1` — бот будет использовать только API 1.0

### Перевод диалога на оператора

При использовании API 2.0 в меню бота можно добавить кнопку, по нажатию на которую диалог будет переводиться на заданного оператора. Для этого необходимо при запуске бота передать ID нужного оператора в опции `--agent-id`:

```shell
extbot --domain demo.webim.ru --token my-secret-token --agent-id 240001
```

Найти ID оператора можно в Webim в разделе "Сотрудники". А в более старых релизах Webim — в адресной строке браузера, перейдя из раздела "Сотрудники" в настройки нужного сотрудника.

### Перевод диалога на отдел

Также в API 2.0 в меню бота можно добавить кнопку, по нажатию на которую диалог будет переводиться в заданный отдел. Для этого необходимо передать буквенный идентификатор нужного отдела в опции `--dep-key`:

```shell
extbot --domain demo.webim.ru --token my-secret-token --dep-key my_department
```

Найти буквенный идентификатор можно в соответствующем поле в настройках отдела в Webim.

### Реакции на файловые сообщения

При использовании API 2.0 бот сможет отличить входящее файловое сообщение от текстового и ответит на него иначе.

### Логи внутренней работы бота

Бота можно запустить с опцией `--debug`, тогда он будет выводить более подробную информацию о своей работе, в том числе данные, которыми обменивается с Webim. Обычно бота лучше запускать без этой опции, чтобы среди внутренних сообщений не затерялись более важные, например сообщения об ошибках.

### Удаление бота

При необходимости бота можно удалить командой:

```shell
pip uninstall extbot
```

## Журнал изменений

См. [CHANGELOG.md](CHANGELOG.md)

## Участие в разработке бота

См. [CONTRIBUTING.md](CONTRIBUTING.md)
